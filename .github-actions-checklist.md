# GitHub Actions OIDC Setup Checklist

Use this checklist to track your progress setting up GitHub Actions with OIDC.

## Phase 1: AWS Setup (10-15 minutes)

### Automated Setup (Recommended)
- [ ] Run `./scripts/setup-oidc.sh`
- [ ] Note the Role ARN output
- [ ] Verify CDK is bootstrapped

### Manual Setup (Alternative)
- [ ] Get AWS Account ID: `aws sts get-caller-identity --profile YOUR_PROFILE`
- [ ] Create OIDC provider in AWS
- [ ] Create `github-trust-policy.json` file
- [ ] Create IAM role `GitHubActionsCDKDeploy`
- [ ] Attach permissions policy (AdministratorAccess or custom)
- [ ] Verify CDK bootstrap: `aws cloudformation describe-stacks --stack-name CDKToolkit`
- [ ] Get Role ARN: `aws iam get-role --role-name GitHubActionsCDKDeploy`

**Role ARN (save this):**
```
arn:aws:iam::YOUR_ACCOUNT_ID:role/GitHubActionsCDKDeploy
```

---

## Phase 2: GitHub Configuration (5 minutes)

- [ ] Go to GitHub repo: https://github.com/dspenard/cdk-cloudwatch-alarms/settings/secrets/actions
- [ ] Click "New repository secret"
- [ ] Add secret:
  - Name: `AWS_ROLE_ARN_DEV`
  - Value: Your Role ARN from Phase 1
- [ ] (Optional) Create GitHub environment named `dev`
- [ ] (Optional) Add protection rules to environment

---

## Phase 3: Update Code (2 minutes)

- [ ] Verify workflow file updated (already done if you used the files I created)
- [ ] Check `.github/workflows/deploy.yml` uses `role-to-assume`
- [ ] Commit changes:
  ```bash
  git add .github/workflows/deploy.yml
  git commit -m "Configure OIDC authentication for GitHub Actions"
  git push origin main
  ```

---

## Phase 4: Test Deployment (10 minutes)

### Test 1: Manual Trigger
- [ ] Go to Actions tab: https://github.com/dspenard/cdk-cloudwatch-alarms/actions
- [ ] Click "Deploy Monitoring Infrastructure"
- [ ] Click "Run workflow"
- [ ] Select branch: `main`, environment: `dev`
- [ ] Click "Run workflow" button
- [ ] Watch the workflow run

### Test 2: Monitor Logs
- [ ] Click on the running workflow
- [ ] Verify "Build" job completes successfully
- [ ] Verify "Deploy-dev" job starts
- [ ] Look for "Assuming role" message in logs
- [ ] Verify deployment completes successfully

### Test 3: Verify in AWS
- [ ] Check CloudFormation stack:
  ```bash
  aws cloudformation describe-stacks --stack-name monitoring-dev --profile YOUR_PROFILE
  ```
- [ ] Check CloudWatch alarms:
  ```bash
  aws cloudwatch describe-alarms --alarm-name-prefix "dev-s3-" --profile YOUR_PROFILE
  ```

---

## Phase 5: Verify Success (2 minutes)

- [ ] GitHub Actions workflow completed with green checkmark ✅
- [ ] CloudFormation stack shows `UPDATE_COMPLETE` or `CREATE_COMPLETE`
- [ ] CloudWatch alarms exist and are in `OK` or `INSUFFICIENT_DATA` state
- [ ] No errors in GitHub Actions logs
- [ ] No AWS credentials stored in GitHub Secrets (only Role ARN)

---

## Troubleshooting (If Needed)

If something fails, check:

- [ ] Role ARN is correct in GitHub Secret
- [ ] Trust policy has correct repository name: `dspenard/cdk-cloudwatch-alarms`
- [ ] OIDC provider exists in AWS
- [ ] IAM role has necessary permissions
- [ ] CDK is bootstrapped in the account
- [ ] Workflow file has `permissions: id-token: write`

See `OIDC_SETUP_GUIDE.md` for detailed troubleshooting steps.

---

## Next Steps (After Success)

- [ ] Set up staging environment (repeat Phase 1-2 for staging account)
- [ ] Set up prod environment (repeat Phase 1-2 for prod account)
- [ ] Configure branch protection rules
- [ ] Add deployment notifications
- [ ] Replace AdministratorAccess with least privilege policy
- [ ] Document the process for your team

---

## Quick Commands Reference

```bash
# Get AWS Account ID
aws sts get-caller-identity --profile YOUR_PROFILE --query Account --output text

# Get Role ARN
aws iam get-role --role-name GitHubActionsCDKDeploy --profile YOUR_PROFILE --query 'Role.Arn' --output text

# Check OIDC provider
aws iam list-open-id-connect-providers --profile YOUR_PROFILE

# Check role policies
aws iam list-attached-role-policies --role-name GitHubActionsCDKDeploy --profile YOUR_PROFILE

# Check CDK bootstrap
aws cloudformation describe-stacks --stack-name CDKToolkit --profile YOUR_PROFILE --region us-east-1

# Verify deployment
aws cloudformation describe-stacks --stack-name monitoring-dev --profile YOUR_PROFILE
```

---

**Status:** [ ] Not Started | [ ] In Progress | [ ] Complete ✅
